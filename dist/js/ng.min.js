var app=angular.module("myApp",["ngCookies","ngRoute","app.ctrls","admin.ctrl","app.directives"],["$httpProvider",function(t){t.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",t.defaults.transformRequest=[function(t){var e=function(t){var n,o,i,c,a,r,l,s="";for(n in t)if(o=t[n],o instanceof Array)for(l=0;l<o.length;++l)a=o[l],i=n+"["+l+"]",r={},r[i]=a,s+=e(r)+"&";else if(o instanceof Object)for(c in o)a=o[c],i=n+"["+c+"]",r={},r[i]=a,s+=e(r)+"&";else void 0!==o&&null!==o&&(s+=encodeURIComponent(n)+"="+encodeURIComponent(o)+"&");return s.length?s.substr(0,s.length-1):s};return angular.isObject(t)&&"[object File]"!==String(t)?e(t):t}]}]);app.config(["$routeProvider","$locationProvider",function(t,e){t.when("/",{controller:"ctrl.home",templateUrl:"views/home.html"}).when("/music",{controller:"ctrl.music",templateUrl:"views/music.html"}).when("/music/pl",{controller:"ctrl.music.pl",templateUrl:"views/music-pl.html"}).when("/music/pl/:id",{controller:"ctrl.music.pl.detail",templateUrl:"views/music-pl-detail.html"}).when("/music/sl",{controller:"ctrl.music.sl",templateUrl:"views/music-sl.html"}).when("/music/song/:id",{controller:"ctrl.music.s.detail",templateUrl:"views/music-s-detail.html"}).when("/movie",{controller:"ctrl.movie",templateUrl:"views/movie.html"}).when("/movie/:id",{controller:"ctrl.movie.detail",templateUrl:"views/movie-detail.html"}).when("/blog",{controller:"ctrl.blog",templateUrl:"views/blog.html"}).when("/blog/cate/:id",{controller:"ctrl.blog.cate",templateUrl:"views/blog.html"}).when("/blog/author/:id",{controller:"ctrl.blog.author",templateUrl:"views/blog.html"}).when("/blog/:id",{controller:"ctrl.blog.detail",templateUrl:"views/blog-detail.html"}).when("/admin/music",{controller:"ctrl.admin.music",templateUrl:"views/admin/music.html"}).when("/admin/movie",{controller:"ctrl.admin.movie",templateUrl:"views/admin/movie.html"}).when("/admin/blog",{controller:"ctrl.admin.blog",templateUrl:"views/admin/blog.html"}).otherwise({redirectTo:"/"})}]),app.run(["$rootScope","$cookieStore","$interval","$timeout","$location","$document","Playlist",function(t,e,n,o,i,c,a){t.$on("$routeChangeSuccess",function(e){var n=t.path=i.path(),o=$(".navbar-nav").children();$(o).removeClass("active"),n.indexOf("/music")>=0?$(o[1]).addClass("active"):n.indexOf("/movie")>=0?$(o[2]).addClass("active"):n.indexOf("/blog")>=0?$(o[3]).addClass("active"):$(o[0]).addClass("active")}),a.getList(function(e){t.playlists=e,void 0===t.playlist&&(t.playlist=t.playlists[0],a.detail(t.playlist.id,function(e){t.songList=e.songList,t.nowSong=t.songList[0]}))}),t.audio=document.getElementById("audio"),t.isPaused=t.audio.paused,e.get("volume")?t.audio.volume=e.get("volume"):t.audio.volume=.6,t.isPaused&&!function(){n(function(){var e=document.getElementById("audio");e.ended&&t.player.next()},1e3)}(),t.player={play:function(){t.audio.play(),t.isPaused=!1,t.player.update()},pause:function(){t.audio.pause(),t.isPaused=!0,t.player.update()},toggle:function(){t.isPaused?t.player.play():t.player.pause()},changeSong:function(e){t.nowSong=e,t.player.play()},pre:function(){var e=t.nowSong.id,n=t.songList.length;angular.forEach(t.songList,function(o,i){o.id==e&&(0===i?t.nowSong=t.songList[n-1]:t.nowSong=t.songList[i-1],t.isPaused?t.player.pause():t.player.play())})},next:function(){var e=t.nowSong.id,n=t.songList.length;angular.forEach(t.songList,function(o,i){o.id==e&&(i==n-1?t.nowSong=t.songList[0]:t.nowSong=t.songList[i+1])})},update:function(){o(function(){document.getElementById("audio")})}},t.$watch("nowSong",function(e,n,o){t.nowSong&&t.audio.setAttribute("src","http://m2.music.126.net/"+t.nowSong.mp3url),t.isPaused?t.player.pause():t.player.play()}),c.bind("keypress",function(e){32==e.keyCode&&(t.isPaused?t.player.play():t.player.pause())})}]),app.controller("ctrl.nav",["$scope","$rootScope","$cookieStore","$location",function(t,e,n,o){t.signout=function(){n.remove("user"),e.account=n.get("user"),o.path(e.path+"/")}}]),app.filter("toStrusted",["$sce",function(t){return function(e){return t.trustAsHtml(e)}}]),app.filter("pagefilter",function(){return function(t,e){return t.push(20)}}),app.filter("formatTime",[function(){return function(t){t=parseInt(t)||0;var e=0,n=0;return t>60?(e=parseInt(t/60),n=t-60*e,e=e>=10?e:"0"+e,n=n>=10?n:"0"+n):(e="00",n=t>=10?t:"0"+t),e+":"+n}}]),app.filter("timestamp",function(){return function(t){return t=t||"",new Date(t.replace(/-/g,"/"))}}),app.filter("add0",function(){return function(t){return t=t||0,t<10?"0"+t.toString():t}}),angular.module("app.ctrls",["app.service"]).controller("ctrl.signup",["$scope","User",function(t,e){t.user=null,t.submit=function(){e.sign("signup",t.user,function(t){t.status&&$("#signupModal").modal("hide")})}}]).controller("ctrl.signin",["$scope","$rootScope","$cookieStore","$timeout","$location","User",function(t,e,n,o,i,c){e.account=n.get("user"),t.user=void 0,t.submit=function(){t.loading=!0,c.sign("signin",t.user,function(c){c.status?($("#signinModal").modal("hide"),o(function(){n.put("user",c.user),e.account=n.get("user"),i.path(e.path+"/")},1e3)):console.log(c.msg),t.loading=!1})}}]).controller("ctrl.home",["$scope",function(t){t.title="i am home page"}]).controller("ctrl.music",["$scope","$rootScope","$http","$interval","$timeout","Tags","Playlist",function(t,e,n,o,i,c,a){t.search=function(){n.get("/static/json/remix.json").success(function(e){t.meList=e,console.log(e.length)})},e.account&&(t.userId=e.account.id),t.create=function(){for(var e=0;e<t.meList.length;e++){var o={name:t.meList[e].name,singer:t.meList[e].artists[0].name,mp3Url:t.meList[e].mp3Url.substring(24),picUrl:t.meList[e].album.picUrl.substring(24),playTime:t.meList[e].lMusic.playTime,publisher:t.userId};n.post(host+"song/create",{song:o})}},t.show=function(t){t.songlist||a.detail(t.id,function(e){t.songlist=e,t.show=!0}),t.show=!t.show},void 0===e.playlists&&a.getList(function(t){e.playlists=t,e.musicList=t[0]}),t.showPlaylistForm=function(){c.getList(function(e){t.tags=e})},t.changePlayList=function(t){e.musicList=t.songlist,e.nowSong=t.songlist[0],e.player.play()},t.submit=function(){t.playlist.creator=t.userId,a.create(t.playlist,function(e){t.playlists.push(e),$("#listModal").modal("hide")})}}]).controller("ctrl.music.pl",["$scope",function(t){}]).controller("ctrl.music.pl.detail",["$scope","$rootScope","$routeParams","$location","Playlist",function(t,e,n,o,i){var c=n.id;0===c&&o.path("/other"),i.detail(c,function(e){t.plInfo=e.plInfo,t.plInfo.songList=e.songList}),t.changePlayList=function(t,n){e.playlist=t,e.songList=n,e.nowSong=e.songList[0],e.isPaused&&e.player.play()},t.addToPl=function(t){var n=[];angular.forEach(t,function(t,o){var i=!0;angular.forEach(e.songList,function(e,n){t.id==e.id&&(i=!1)}),i&&n.push(t)}),e.songList=e.songList.concat(n)},t.title="音乐详情"}]).controller("ctrl.music.sl",["$scope","Song",function(t,e){function n(){e.getList(t.page,function(e){t.allSongs=e.songList,t.songCount=e.count,t.pageNum=10})}t.page=0,t.$watch("page",function(){n()})}]).controller("ctrl.music.song.detail",["$scope","$routeParams","$location",function(t,e,n){var o=e.id;0===o&&n.path("/other"),t.title="音乐详情"}]).controller("ctrl.movie",["$scope","Movie","$rootScope",function(t,e,n){function o(){var o=null;n.account&&(o=n.account.id),e.getList(t.page,o,function(e){t.movieList=e.mlist,t.movieCount=e.count,t.pageNum=6})}t.movieApi="请选择",t.getApi=function(){t.loading=!0,e.getApi(t.name,function(e){void 0!==e.data&&(t.movies=e.data.movie,t.movies.num=e.data.num),t.loading=!1})},t.selectMovie=function(e){t.movie=$.parseJSON(e)},t.submit=function(){t.movie.publisher=n.account.id,e.create({movie:t.movie,review:t.review},function(e){$("#movieModal").modal("hide"),t.movie={},t.movieList.unshift(e)})},t.page=0,t.$watch("page",function(){o()})}]).controller("ctrl.movie.detail",["$scope","$rootScope","$routeParams","$location","Movie","MovieReview",function(t,e,n,o,i,c){var a=n.id;0===a&&o.path("/other");var r;e.account&&(r=e.account.id),i.detail(a,r,function(e){t.movie=e.movie,t.reviews=e.reviews,t.review=e.userReview,t.review&&(t.review.content=t.review.content.replace(/<br\/>/gi,"\n")),t.slotLimit=e.movie.slot.length>100?100:e.slot.length}),t.submit=function(){var n={score:t.review.score,content:t.review.content.replace(/\n/g,"<br/>")};t.review.id?(n.id=t.review.id,c.edit(n,function(t){$("#reviewModal").modal("hide")})):(n.writer=e.account.id,n.movie=t.movie.id,c.create(n,function(t){$("#reviewModal").modal("hide")}))},t.title="电影详情"}]).controller("ctrl.blog",["$scope","$rootScope","$timeout","Blog","Category",function(t,e,n,o,i){function c(){t.hasMoreBlogs=!0,t.loading=!0,o.getList(null,t.page,function(e){o.createItem(e),t.loading=!1,0===e.length&&(t.hasMoreBlogs=!1,t.loading=!0,t.msg="没有更多内容了！")})}t.blog={category:null},t.page=0,t.showBlogModal=function(){t.showBlogForm=!0,i.getList(function(e){t.cateList=e,t.cateList&&(t.blog.category=e[0].id)})},t.loadMore=function(){t.page=t.page+1},t.$watch("page",function(){c()}),t.blogSubmit=function(){t.blog.author=e.account.id,o.create(t.blog,function(e){$("#blogModal").modal("hide"),t.blog={category:1},o.createItem(e)})},t.title="所有博客"}]).controller("ctrl.blog.cate",["$scope","$routeParams","$location","Blog",function(t,e,n,o){var i=e.id;0===i&&n.path("/other"),o.getList({action:"cid",id:i},0,function(e){o.createItem(e),t.title="C:"+e[0].cname})}]).controller("ctrl.blog.author",["$scope","$rootScope","$routeParams","$location","Blog",function(t,e,n,o,i){var c=n.id;0===c&&o.path("/other"),i.getList({action:"uid",id:c},0,function(e){i.createItem(e),t.title="U:"+e[0].uid})}]).controller("ctrl.blog.detail",["$scope","$routeParams","$location","$sce","Blog",function(t,e,n,o,i){var c=e.id;0===c&&n.path("/other"),i.detail(c,function(e){t.blogInfo=e}),t.title="博客详情"}]),angular.module("admin.ctrl",[]),angular.module("app.directives",["app.service"]).directive("siteNav",function(){return{link:function(t,e,n,o){$(e).children().click(function(t){$(e).children().click(function(){$(this).siblings().removeClass("active"),$(this).addClass("active")})})}}}).directive("ensureUnique",["$http",function(t){return{require:"ngModel",link:function(e,n,o,i){n.on("blur",function(){var e=o.name,n=i.$modelValue;n||0===n.length||t.post(host+o.ensureUnique+"/unique"+e,{name:n}).success(function(t,e,n,o){i.$setValidity("unique",$.parseJSON(t))}).error(function(t,e,n,o){i.$setValidity("unique",!1)})})}}}]).directive("masonry",["$timeout",function(t){return{require:"ngModel",link:function(t,e,n,o){}}}]).directive("scroll",["$window",function(t){return function(e,n,o){angular.element(t).bind("scroll",function(t){$(window).scrollTop()>=$(document).height()-$(window).height()&&e.hasMoreBlogs&&(e.page+=1,e.$apply())})}}]).directive("requireLogin",["$rootScope",function(t){return{restrict:"A",link:function(e,n,o,i){var c=o.target;e.$watch("account",function(){void 0===t.account?(o.$set("data-toggle","modal"),o.$set("data-target","#signinModal")):o.$set("data-target",c)})}}}]).directive("progress",["$rootScope",function(t){return{link:function(e,n,o,i){document.getElementById("audio");n.bind("click",function(o){var i=n[0].getBoundingClientRect(),c=i.left,a=o.clientX,r=(a-c)/i.width;r=r>1?1:r;var l=e.audio.duration,s=l*r;e.audio.currentTime=s,t.player.update()})}}}]).directive("volume",["$rootScope","$cookieStore",function(t,e){return{link:function(n,o,i){document.getElementById("audio");o.bind("click",function(i){var c=o[0].getBoundingClientRect(),a=c.left,r=i.clientX,l=(r-a)/c.width;l=l>1?1:l,n.audio.volume=l,t.player.update(),e.put("volume",l)})}}}]).directive("volumeToggle",["$rootScope","$cookieStore",function(t,e){return{link:function(n,o,i){o.bind("click",function(o){n.audio.volume>0?(i.$set("original",n.audio.volume),n.audio.volume=0):n.audio.volume=i.original,t.player.update(),e.put("volume",n.audio.volume)})}}}]).directive("zan",["Zan","$rootScope",function(t,e){return{restrict:"A",replace:!0,scope:{model:"=",type:"="},template:'<span require-login class="zan" ng-class="{\'has-zan\': model.zan}"><i class="fa fa-thumbs-o-up" ng-class="{\'fa-thumbs-up\':model.zan}"></i> {{model.flower}}</span>',link:function(n,o,i,c){o.on("click",function(){if(e.account){var o={type:n.type,objId:n.model.id,user:e.account.id};t.save(o,function(t){"create"==t.action?(n.model.flower=parseInt(n.model.flower)+1,n.model.zan=1):"delete"==t.action&&(n.model.flower=parseInt(n.model.flower)-1,n.model.zan=null)})}})}}}]).directive("toolMenu",function(){return{link:function(t,e,n,o){var i=document.getElementById("addToPL");e.bind("click",function(n){var o=n.clientX,c=n.clientY;return $(i).show(),$(i).css("left",o+5),$(i).css("top",c),$(i).attr("sid",t.s.id),$(e[0].parentNode.parentNode).siblings().removeClass("active"),$(e[0].parentNode.parentNode).addClass("active"),!1})}}}).directive("sitem",function(){return{link:function(t,e,n,o){var i=document.getElementById("addToPL");e.bind("click",function(t){$(e).siblings().removeClass("active"),$(e).addClass("active"),$(i).hide()})}}}).directive("addToPlaylist",["Playlist",function(t){return{link:function(e,n,o,i){var c=document.getElementById("addToPL");n.bind("click",function(){var n=$(c).attr("sid"),o=e.pl.id;t.updateSongs(n,o,"add",function(t){1===t&&$(c).hide()})})}}}]).directive("miniPager",["$interval",function(t){return{restrict:"A",replace:!0,scope:{pnum:"=",page:"=",rcount:"=",source:"="},template:'<nav class="clearfix"><ul class="pagination pagination-sm"><li><button ng-disabled="page==0" ng-click="changePage(page-1)" aria-label="Previous"><span aria-hidden="true">&laquo;</span></button></li><li ng-class="{\'active\':page==p}" ng-repeat="p in pager"><a ng-click="changePage(p)">{{p+1}}</a></li><li><button ng-disabled="page==(pcount-1)" ng-click="changePage(page+1)" aria-label="Next"><span aria-hidden="true">&raquo;</span></button></li></ul><div class="page-count" ng-bind-template="(共{{pcount}}页/{{rcount}}条)"></div></nav>',controller:["$scope",function(t){}],link:function(t,e,n,o){t.changePage=function(e){t.page=e},t.$watch("source",function(){for(var e=t.pcount=t.rcount%t.pnum===0?t.rcount/t.pnum:parseInt(t.rcount/t.pnum)+1,n=[],o=0;o<e;o++)n.push(o);void 0===t.pager||t.page<3?t.pager=n.slice(0,5):n.length-t.page<3?t.pager=n.slice(-5):t.page>=3&&(t.pager=n.slice(t.page-2,t.page+3))})}}}]).directive("textareaEditor",function(){return{restrict:"A",link:function(t,e,n,o){t.$watch("review.content",function(t,e,n){console.log(n),n.review})}}}).directive("scrollBar",["$timeout",function(t){return{link:function(t,e,n,o){t.$watch("songList",function(t,n,o){var i=e[0];i.scrollHeight}),e.bind("click",function(){})}}}]).directive("roll",["$interval","$timeout",function(t,e){return{link:function(n,o,i,c){var a;n.roll=function(){var i=o[0].parentNode,c=o[0].children[0],r=o[0].children[1];e(function(){i.offsetWidth<c.offsetWidth?(r.innerText=c.innerText,t.cancel(a),a=t(function(){r.offsetWidth-(i.scrollLeft-60)<=0?(t.cancel(a),a=void 0,i.scrollLeft=0,setTimeout(function(){n.roll()},3e3)):i.scrollLeft++},20)):(t.cancel(a),a=void 0,r.innerText="")})},n.$watch("nowSong",function(){n.roll()})}}}]).directive("coverHover",function(){return{link:function(t,e,n,o){e.bind("mouseover",function(){$(e[0].children[2]).show()}),e.bind("mouseleave",function(){$(e[0].children[2]).hide()})}}}).directive("contenteditable",function(){return{restrict:"A",require:"?ngModel",link:function(t,e,n,o){function i(){var t=e.html();n.stripBr&&"<br>"===t&&(t=""),o.$setViewValue(t)}o&&(o.$render=function(){e.html(o.$viewValue||"")},e.on("blur keyup change",function(){t.$apply(i)}))}}}),$(function(){$("#cateModal").on("hide.bs.modal",function(){$("form[name='cateForm']")[0].reset()}),$("#blogModal").on("hide.bs.modal",function(){$("form[name='blogForm']")[0].reset()}),$(".navbar-nav").children().click(function(t){$(this).siblings().removeClass("active"),$(this).addClass("active")}),$("body").niceScroll({cursorcolor:"#ccc",cursoropacitymax:1,touchbehavior:!1,cursorwidth:"6px",cursorborder:"0",cursorborderradius:"6px",autohidemode:!1}),$("#boxscroll").niceScroll({cursorcolor:"#ccc",cursoropacitymax:1,touchbehavior:!1,cursorwidth:"6px",cursorborder:"0",cursorborderradius:"6px",autohidemode:!1})});var host="http://ansux.96.lt/blog/index.php/blogs/";angular.module("app.service",[]).factory("User",["$http","$cookieStore","$rootScope",function(t,e,n){return{sign:function(e,n,o){t.post(host+"user/"+e,{user:n}).then(function(t){o(JSON.parse(t.data))})}}}]).factory("Category",["$http",function(t){return{getList:function(e){t.get(host+"category/getList",{cache:!0}).then(function(t){e(JSON.parse(t.data))})}}}]).factory("Blog",["$http",function(t){return{create:function(e,n){t.post(host+"blog/create",{blog:e}).then(function(t){n(JSON.parse(t.data))})},getList:function(e,n,o){var i="";null!==e?i="?"+e.action+"="+e.id+"&page="+n:i+="?page="+n,t.get(host+"blog/getlist"+i).then(function(t){o(JSON.parse(t.data))})},detail:function(e,n){t.get(host+"blog/detail?id="+e).success(function(t){n(JSON.parse(t))})},createItem:function(t){function e(t){var e=$('<div class="grid-item col-lg-3 col-md-4 col-sm-4 col-xs-6"><div class="thumbnail"><img src="'+t.thumb+'" alt=""><div class="caption"><h4><a href="#/blog/'+t.id+'">'+t.title.substr(0,20)+"</a></h4><p><span>"+t.cname.substr(0,2)+"</span>"+t.digest.substr(0,60)+"...</p></div></div></div>"),n=$(".grid").masonry({itemSelector:".grid-item",columnWidth:".grid-item"});n.imagesLoaded().progress(function(){n.masonry("layout")}),n.append(e).masonry("appended",e)}if(void 0===t.length)e(t);else if(t.length>0)for(var n=0;n<t.length;n++)e(t[n])}}}]).factory("Movie",["$http",function(t){return{getApi:function(e,n){t.get(host+"movie/api?name="+e).then(function(t){n(t.data)})},create:function(e,n){var o=e.movie.actor,i=[];if(o.constructor===Array)for(var c=0;c<o.length;c++)i.push(o[c].trim());else if(o.constructor===String)for(var a=o.replace(/,/g,"，").split("，"),r=0;r<a.length;r++)i.push(a[r].trim());e.movie.actor=i.join("，"),e.review&&e.review.content&&(e.review.content=e.review.content.replace(/\n/g,"<br/>")),t.post(host+"movie/create",{movie:e.movie,review:e.review}).then(function(t){n(JSON.parse(t.data))})},getList:function(e,n,o){var i="movie/getlist?page="+e;n||(i+="&uid="+n),t.get(host+i).then(function(t){o(JSON.parse(t.data))})},detail:function(e,n,o){var i="?id="+e;void 0!==n&&(i+="&uid="+n),t.get(host+"movie/detail"+i).then(function(t){o(JSON.parse(t.data))})}}}]).factory("MovieReview",["$http",function(t){return{create:function(e,n){t.post(host+"MovieReview/create",{review:e}).then(function(t){n(t)})},edit:function(e,n){t.post(host+"MovieReview/edit",{review:e}).then(function(t){n(t)})}}}]).factory("Zan",["$http",function(t){return{save:function(e,n){t.post(host+"Zan/Create",{zan:e}).then(function(t){n(JSON.parse(t.data))})}}}]).factory("Song",["$http",function(t){return{getList:function(e,n){t.get(host+"song/getList?page="+e).success(function(t){n(JSON.parse(t))})}}}]).factory("Tags",["$http",function(t){return{getList:function(e){t.get(host+"playlist/GetTagsList").success(function(t){e(JSON.parse(t))})}}}]).factory("Playlist",["$http",function(t){return{getList:function(e){t.get(host+"playlist/getlist").success(function(t){e(JSON.parse(t))})},create:function(e,n){t.post(host+"playlist/create",{playlist:e}).success(function(t){n(JSON.parse(t))})},detail:function(e,n){t.get(host+"playlist/detail?id="+e).success(function(t){n(JSON.parse(t))})},updateSongs:function(e,n,o,i){t.post(host+"playlist/updateSongs",{sid:e,pid:n,action:o}).success(function(t){i(JSON.parse(t))})}}}]);